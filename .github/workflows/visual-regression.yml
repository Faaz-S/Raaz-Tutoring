name: Visual Regression and Performance Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  visual-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Build application
      run: npm run build
      
    - name: Run visual regression tests
      run: npm run test:visual:ci
      env:
        CI: true
        VISUAL_THRESHOLD: 0.2
        MAX_DIFF_PIXELS: 100
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: visual-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30
        
    - name: Upload screenshots on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: visual-test-failures
        path: |
          test-results/visual/
          test-results/screenshots/
        retention-days: 7
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && failure()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const resultsPath = path.join(process.cwd(), 'test-results', 'visual-results.json');
            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const failedTests = results.suites.flatMap(suite => 
                suite.specs.filter(spec => spec.tests.some(test => test.status === 'failed'))
              );
              
              if (failedTests.length > 0) {
                const comment = `## ğŸ” Visual Regression Test Results
                
**âŒ ${failedTests.length} visual test(s) failed**

The following visual tests detected changes:
${failedTests.map(test => `- ${test.title}`).join('\n')}

Please review the uploaded artifacts to see the visual differences.
                
[View detailed results](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }
          } catch (error) {
            console.log('Could not post PR comment:', error.message);
          }

  update-baselines:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Build application
      run: npm run build
      
    - name: Update visual baselines
      run: npm run test:visual:update
      env:
        UPDATE_BASELINES: true
        
    - name: Commit updated baselines
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add tests/visual/
        if git diff --staged --quiet; then
          echo "No baseline changes to commit"
        else
          git commit -m "Update visual regression baselines [skip ci]"
          git push
        fi

  performance-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Build application
      run: npm run build
      
    - name: Run performance tests
      run: npm run test:performance
      env:
        CI: true
        
    - name: Run Lighthouse CI
      run: npm run test:lighthouse
      env:
        CI: true
        
    - name: Generate performance dashboard
      run: |
        node -e "
          import('./tests/performance/performance-dashboard.js')
            .then(module => module.generatePerformanceDashboard())
            .catch(console.error);
        "
        
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          test-results/performance/
          test-results/lighthouse/
        retention-days: 30
        
    - name: Comment PR with performance results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const performanceDir = path.join(process.cwd(), 'test-results', 'performance');
            if (fs.existsSync(performanceDir)) {
              const files = fs.readdirSync(performanceDir);
              const latestResult = files
                .filter(f => f.endsWith('.json'))
                .sort()
                .pop();
              
              if (latestResult) {
                const resultPath = path.join(performanceDir, latestResult);
                const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                
                let comment = '## ğŸ“Š Performance Test Results\n\n';
                
                if (result.metrics) {
                  const score = Math.round(result.metrics['performance-score'] || 0);
                  const fcp = Math.round(result.metrics['first-contentful-paint'] || 0);
                  const lcp = Math.round(result.metrics['largest-contentful-paint'] || 0);
                  const cls = (result.metrics['cumulative-layout-shift'] || 0).toFixed(3);
                  
                  comment += '| Metric | Value | Status |\n';
                  comment += '|--------|-------|--------|\n';
                  comment += `| Performance Score | ${score}% | ${score >= 80 ? 'âœ…' : 'âŒ'} |\n`;
                  comment += `| First Contentful Paint | ${fcp}ms | ${fcp <= 1800 ? 'âœ…' : 'âŒ'} |\n`;
                  comment += `| Largest Contentful Paint | ${lcp}ms | ${lcp <= 2500 ? 'âœ…' : 'âŒ'} |\n`;
                  comment += `| Cumulative Layout Shift | ${cls} | ${cls <= 0.1 ? 'âœ…' : 'âŒ'} |\n\n`;
                }
                
                comment += `[View detailed results](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }
          } catch (error) {
            console.log('Could not post performance comment:', error.message);
          }